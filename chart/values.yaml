# Default values for openprime-app-backend.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 2

image:
  repository: ghcr.io/devopsgroupeu/openprime-app-backend
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "main"

imagePullSecrets:
  - name: ghcr-secret
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}

podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  port: 3001
  targetPort: 3001

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: api.openprime.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: openprime-api-tls
  #    hosts:
  #      - api.openprime.local

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - openprime-app-backend
        topologyKey: kubernetes.io/hostname

# Application specific configuration
app:
  # Environment variables for the Node.js app
  env:
    # Application configuration
    NODE_ENV: "production"
    PORT: "3001"
    LOG_LEVEL: "info"
    
    # Database configuration
    DB_HOST: "openprime-postgres"
    DB_PORT: "5432"
    DB_NAME: "openprime"
    DB_USER: "openprime_user"
    
    # External service URLs
    FRONTEND_URL: "http://openprime-app"
    KEYCLOAK_URL: "http://openprime-keycloak:8080"
    KEYCLOAK_REALM: "openprime"
    KEYCLOAK_CLIENT_ID: "openprime-app"
    INJECTO_SERVICE_URL: "http://injecto:8000"
    
    # AWS Configuration (if needed)
    AWS_REGION: "us-east-1"

    # Infrastructure templates repository configuration
    INFRA_TEMPLATES_REPO_URL: "https://github.com/devopsgroupeu/openprime-infra-templates.git"
    INFRA_TEMPLATES_BRANCH: "main"

  # Secrets (should be provided via external secret management)
  # Use existing secret instead of creating one from values
  existingSecret: ""
  # Keys to load from existing secret (only used when existingSecret is set)
  existingSecretKeys:
    - DB_PASSWORD
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - BEDROCK_INFERENCE_PROFILE_ARN
    - CREDENTIALS_ENCRYPTION_KEY
  # Secrets to create (only used when existingSecret is not set)
  secrets:
    # Database password
    DB_PASSWORD: "openprime123"
    # AWS credentials for Bedrock AI integration
    AWS_ACCESS_KEY_ID: "secret"
    AWS_SECRET_ACCESS_KEY: "secret"
    BEDROCK_INFERENCE_PROFILE_ARN: "secret"

# Persistent volumes
persistence:
  enabled: true
  # Storage for uploads
  uploads:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 5Gi
    mountPath: /app/uploads
  # Storage for logs
  logs:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteMany
    size: 2Gi
    mountPath: /app/logs

# Health check configuration
healthCheck:
  enabled: true
  livenessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Network policies
networkPolicy:
  enabled: false
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: openprime-app
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: injecto
  egress:
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: openprime-postgres
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: openprime-keycloak